order_mapper:
  # 核心：寻找符合库存条件的待处理任务
  find_matching_tasks: >
    SELECT 
        t.id AS task_id,
        t.artist,
        t.customer_info,
        t.contact_phone,
        i.sku_id,
        i.price,
        i.price_name,
        i.perform_id
    FROM order_tasks t
    JOIN ticket_items i ON t.artist = i.project_title
    WHERE t.status = 0               -- 状态：待处理
      AND i.stock_status = 1         -- 状态：有票
      -- 匹配票价 (如果任务指定了票价)
      AND (t.target_price IS NULL OR t.target_price = i.price)
      -- 匹配日期 (将 datetime 转为 date 进行比对)
      AND (t.target_date IS NULL OR t.target_date = DATE(i.perform_time))
    ORDER BY t.created_at ASC        -- 先下单的优先抢

  # 更新任务状态
  update_task_status: >
    UPDATE order_tasks 
    SET status = {{ status }},
        created_at = NOW()
    WHERE id = {{ task_id }}